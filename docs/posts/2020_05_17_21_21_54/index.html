<!doctype html><html lang=ja-jp><head><title>プログラミング言語Go完全入門 - jagijagijag1 tiny tech notes</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel=stylesheet><link rel=stylesheet href=http://jagijagijag1.github.io/tiny-note/css/bootstrap.css><link rel=stylesheet href=http://jagijagijag1.github.io/tiny-note/css/custom.css></head><body><main id=main><div class=container><div class="row justify-content-center text-center my-5"><div class=col-lg-10><a href=http://jagijagijag1.github.io/tiny-note/categories/%E9%96%8B%E7%99%BA%E3%83%A1%E3%83%A2/ class="d-inline-block link-cta mb-4 text-uppercase">開発メモ</a><h1 class="mb-4 text-center">プログラミング言語Go完全入門</h1><p class="small mb-5 text-center"><span class=text-uppercase>May 17, 2020</span></p></div></div></div><div class="bg-skew bg-skew-light"><div class=container><div class="row justify-content-center"><div class=col-lg-8><article class=pb-2><h2 id=1-goに触れる>1. Goに触れる</h2><ul><li>Goの特徴<ul><li>シンプルで協力な記述<ul><li>機能を増やすことで言語を拡張していくことはしない</li></ul></li><li>並行プログラミング<ul><li>マルチコア前提，並行処理とガーベッジコレクション</li><li>goroutine: 軽量スレッド的なもの，<code>go</code>キーワードをつけるだけ，e.g. <code>go f()</code>で関数を並行呼び出し</li></ul></li><li>必要なライブラリやツールが標準で同梱されてる</li><li>シングルバイナリ・クロスコンパイル<ul><li>コマンドラインツールの開発に向いてる</li><li>組み込み・IoTにも (TinyGoという組み込み向けのサブセットもある)</li><li>フロントエンド向け，wasm以外にもGopherJSというのもある</li></ul></li><li>静的解析しやすい言語</li></ul></li><li>Goのバージョン<ul><li>Go1の間は後方互換</li><li>Go2＝Go1.xを拡張していって，後方互換が保てなくなる場合にGo2にするというポリシ</li></ul></li><li>重要そうな技術<ul><li>gRPC</li><li>gVisor</li></ul></li><li>学習ソース<ul><li><a href=https://go.dev/>go.dev</a></li><li><a href=https://knsh14.github.io/translations/go-codereview-comments/>Go Codereview Comments</a><ul><li>Goらしい書き方</li></ul></li></ul></li></ul><h2 id=2-基本構文>2. 基本構文</h2><ul><li>数値をアンダースコアで区切れる<ul><li>e.g. <code>5_000_000</code></li></ul></li><li>連続整数を<code>iota</code>で定義できる<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>const</span> (
      <span style=color:#a6e22e>a</span> = <span style=color:#66d9ef>iota</span>
      <span style=color:#a6e22e>b</span>
      <span style=color:#a6e22e>c</span>
  )
  <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%d, %d, %d&#34;</span>, <span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>c</span>) <span style=color:#75715e>// -&gt; 1, 2, 3
</span></code></pre></div></li></ul><h2 id=3-関数と型>3. 関数と型</h2><ul><li>少し特殊な配列定義方法</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>array1</span> <span style=color:#f92672>:=</span> [<span style=color:#f92672>...</span>]<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>array1</span>) <span style=color:#75715e>// [1 2 3]
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>array2</span> <span style=color:#f92672>:=</span> [<span style=color:#f92672>...</span>]<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>5</span>: <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>10</span>: <span style=color:#ae81ff>100</span>}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>array2</span>) <span style=color:#75715e>// [0 0 0 0 0 50 0 0 0 0 10]
</span></code></pre></div><ul><li><p>arrayとslice</p><ul><li>arrayは固定長，静的</li><li>sliceは参照型，可変長，動的<ul><li>sliceの容量はメモリ確保済みのサイズなので拡張可能</li><li>容量オーバーしたら基本的に２倍の値を確保</li></ul></li></ul></li><li><p>slice trick</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#75715e>// slice tricks: cut
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>aa</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>int</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>}
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>aa</span>) <span style=color:#75715e>// [1, 2, 3, 4, 5]
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>aa</span> = append(<span style=color:#a6e22e>aa</span>[:<span style=color:#ae81ff>2</span>], <span style=color:#a6e22e>aa</span>[<span style=color:#ae81ff>3</span>:]<span style=color:#f92672>...</span>)
	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>aa</span>) <span style=color:#75715e>// [1, 2, 4, 5]
</span></code></pre></div><h2 id=4-パッケージ>4. パッケージ</h2><ul><li>go get => dep => modules (vgo)</li><li>modulesを使う<ul><li><code>go mod init</code> でgo.modを生成</li><li>main作成<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
    
<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;fmt&#34;</span>
    
    <span style=color:#e6db74>&#34;github.com/tenntenn/greeting&#34;</span>
)
    
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>greeting</span>.<span style=color:#a6e22e>Do</span>())
}
</code></pre></div></li><li><code>go run xxx.go</code> するとgo.modにパッケージ追記されて実行できる<ul><li>runする前に<code>go mod tidy</code>してもOK</li><li>vendorディレクトリ配下にパッケージダウンロードするときは<code>go mod vendor</code></li></ul></li><li>後方互換のないバージョン使う場合はimport時の記述を変える<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
    
<span style=color:#f92672>import</span> (
    <span style=color:#e6db74>&#34;fmt&#34;</span>
  <span style=color:#e6db74>&#34;time&#34;</span>
    
    <span style=color:#e6db74>&#34;github.com/tenntenn/greeting/v2&#34;</span>
)
    
<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
  <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>greeting</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()))
}
</code></pre></div></li></ul></li></ul><h2 id=5-コマンドラインツール>5. コマンドラインツール</h2><ul><li>forでファイル処理したいとき→forの中でdeferせず処理を関数化して関数の方でdeferする</li><li>NG<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>fileNames</span> {
  <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fn</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
    <span style=color:#75715e>// エラー処理
</span><span style=color:#75715e></span>  }
  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>() <span style=color:#75715e>// fを使った処理
</span><span style=color:#75715e></span>}
</code></pre></div></li><li>OK<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>fileNames</span> {
  <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>fn</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#75715e>/* エラー処理 */</span> }
}
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
  <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>fn</span>)
  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span> }
    <span style=color:#75715e>// fを使った処理
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>()
}
</code></pre></div></li></ul><h2 id=6-抽象化>6. 抽象化</h2><ul><li>型スイッチ</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#75715e>// type switch
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>interface</span>{}
	<span style=color:#a6e22e>i</span> = <span style=color:#ae81ff>100</span>
	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>.(<span style=color:#66d9ef>type</span>) {
	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>:
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>v</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>v</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;hoge&#34;</span>)
	<span style=color:#66d9ef>default</span>:
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;default&#34;</span>)
	} 
</code></pre></div><h2 id=8-テストとテスタビリティ>8. テストとテスタビリティ</h2><ul><li><p><code>Example</code>で始まる関数名のテストを書くとGoDocにサンプルとして出力される</p></li><li><p>テーブル駆動テスト + サブテスト</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestIsOdd</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
  <span style=color:#a6e22e>cases</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>struct</span> {<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>; <span style=color:#a6e22e>input</span> <span style=color:#66d9ef>int</span>; <span style=color:#a6e22e>expected</span> <span style=color:#66d9ef>bool</span>}{
    {<span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;+odd&#34;</span>, <span style=color:#a6e22e>input</span>: <span style=color:#ae81ff>5</span>, <span style=color:#a6e22e>expected</span>: <span style=color:#66d9ef>true</span>},
    {<span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;+even&#34;</span>, <span style=color:#a6e22e>input</span>: <span style=color:#ae81ff>6</span>, <span style=color:#a6e22e>expected</span>: <span style=color:#66d9ef>false</span>},
    {<span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;-odd&#34;</span>, <span style=color:#a6e22e>input</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>, <span style=color:#a6e22e>expected</span>: <span style=color:#66d9ef>true</span>},
    {<span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;-even&#34;</span>, <span style=color:#a6e22e>input</span>: <span style=color:#f92672>-</span><span style=color:#ae81ff>6</span>, <span style=color:#a6e22e>expected</span>: <span style=color:#66d9ef>false</span>},
    {<span style=color:#a6e22e>name</span>: <span style=color:#e6db74>&#34;zero&#34;</span>, <span style=color:#a6e22e>input</span>: <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>expected</span>: <span style=color:#66d9ef>false</span>},
  }
  
  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cases</span> {
    <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>
    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>name</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>actual</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>IsOdd</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>input</span>); <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>expected</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>actual</span> {
        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Errorf</span>(
          <span style=color:#e6db74>&#34;want IsOdd(%d) = %v, got %v&#34;</span>,
          <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>input</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>expected</span>, <span style=color:#a6e22e>actual</span>)
      }
    })
  }
}
</code></pre></div><ul><li>テストデータは<code>testdata</code>というディレクトリに入れる<ul><li>パッケージとして認識されなくなる</li></ul></li></ul><h2 id=9-ゴールーチンとチャネル>9. ゴールーチンとチャネル</h2><ul><li>goroutineが切り替わるタイミング<ul><li>(ブロックされる)チャネルへの読み書き</li><li>待ちが発生するシステムコール</li><li><code>time.Sleep</code></li><li>メモリ割り当て</li><li><code>runtime.Gosched</code></li></ul></li><li>チャネルをcloseすると受信場所にゼロ値が送られる＝ブロードキャスト，処理終了通知として使われる</li></ul><p class="mt-5 text-center"><span class=text-secondary>Tagged:</span>
<a href=http://jagijagijag1.github.io/tiny-note/tags/go/ class="link-tag text-dark">#Go</a></p></article><div class="row pt-5 pb-5"><div class="col-6 text-left"><a class=text-reset href=http://jagijagijag1.github.io/tiny-note/posts/2020_05_16_16_53_38/>&larr; Go + WebAssembly お試し</a></div><div class="col-6 text-right"><a class=text-reset href=http://jagijagijag1.github.io/tiny-note/posts/2020_05_20_12_05_28/>Pythonデコレータ &rarr;</a></div></div></div></div></div></div></main><footer class="site-footer mt-5"><div class=container><div class="row justify-content-md-between"><div class="col-sm-12 col-md-4 mb-4"><h2 class="h5 mb-3">jagijagijag1 tiny tech notes</h2><p>Tiny fragments for my tech activities. More cohesive articles are on https://jagijagijag1.github.io/blog/</p></div><section id=pixela_access_counter class="col-sm-12 col-md-4 mb-4"><header><h5>Blog PVs</h5></header><div id=svg-load-area style="border:1px solid rgba(161,161,161,.3)"></div><div style=text-align:right>Powered by <a href=https://pixe.la/ target=_blank>Pixela</a></div></section><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://unpkg.com/tippy.js@3/dist/tippy.all.min.js></script><script>document.addEventListener('DOMContentLoaded',function(){$('#svg-load-area').load('https:\/\/pixe.la\/v1\/users\/jagijagijag1\/graphs\/pomodoro?mode=short',function(){tippy('.each-day',{arrow:true});});});</script><div class="col-4 col-md-2 mb-4"><h2 class="h5 mb-3">Menu</h2><ul class="nav flex-column"><li class=mb-1><a href=http://jagijagijag1.github.io/tiny-note/ class=text-secondary>Home</a></li><li class=mb-1><a href=https://jagijagijag1.github.io/blog/ class=text-secondary>Blog (external)</a></li></ul></div></div><hr><div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-center"><div class="text-muted mb-3"><a href=https://10mohi6.tk class=text-reset>design</a> <a href=https://github.com/10mohi6/hugo-theme-simple-blog class=text-reset>theme</a></p></div></div></div></footer></body></html>