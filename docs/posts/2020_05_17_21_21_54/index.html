<!doctype html><html lang=ja-jp><head><title>プログラミング言語Go完全入門 - jagijagijag1 tiny tech notes</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel=stylesheet><link rel=stylesheet href=https://jagijagijag1.github.io/tiny-notes/css/bootstrap.css><link rel=stylesheet href=https://jagijagijag1.github.io/tiny-notes/css/custom.css><link rel=stylesheet href=https://jagijagijag1.github.io/tiny-notes/css/add-on.css><link rel=stylesheet href=https://jagijagijag1.github.io/tiny-notes/css/syntax.css><meta name=google-site-verification content="vaSgNHX9ucxZv0PzPwYiiKG-Sz_XDKjNOj1YTnzWwk0"></head><body><main id=main><div class=container><div class="row justify-content-center text-center my-5"><div class=col-lg-10><a href=https://jagijagijag1.github.io/tiny-notes/categories/%E9%96%8B%E7%99%BA%E3%83%A1%E3%83%A2/ class="d-inline-block link-cta mb-4 text-uppercase">開発メモ</a><h1 class="mb-4 text-center">プログラミング言語Go完全入門</h1><p class="small mb-5 text-center"><span class=text-uppercase>May 17, 2020</span></p></div></div></div><div class="bg-skew bg-skew-light"><div class=container><div class="row justify-content-center"><div class=col-lg-8><article class=pb-2><h2 id=1-goに触れる>1. Goに触れる</h2><ul><li>Goの特徴<ul><li>シンプルで協力な記述<ul><li>機能を増やすことで言語を拡張していくことはしない</li></ul></li><li>並行プログラミング<ul><li>マルチコア前提，並行処理とガーベッジコレクション</li><li>goroutine: 軽量スレッド的なもの，<code>go</code>キーワードをつけるだけ，e.g. <code>go f()</code>で関数を並行呼び出し</li></ul></li><li>必要なライブラリやツールが標準で同梱されてる</li><li>シングルバイナリ・クロスコンパイル<ul><li>コマンドラインツールの開発に向いてる</li><li>組み込み・IoTにも (TinyGoという組み込み向けのサブセットもある)</li><li>フロントエンド向け，wasm以外にもGopherJSというのもある</li></ul></li><li>静的解析しやすい言語</li></ul></li><li>Goのバージョン<ul><li>Go1の間は後方互換</li><li>Go2＝Go1.xを拡張していって，後方互換が保てなくなる場合にGo2にするというポリシ</li></ul></li><li>重要そうな技術<ul><li>gRPC</li><li>gVisor</li></ul></li><li>学習ソース<ul><li><a href=https://go.dev/>go.dev</a></li><li><a href=https://knsh14.github.io/translations/go-codereview-comments/>Go Codereview Comments</a><ul><li>Goらしい書き方</li></ul></li></ul></li></ul><h2 id=2-基本構文>2. 基本構文</h2><ul><li>数値をアンダースコアで区切れる<ul><li>e.g. <code>5_000_000</code></li></ul></li><li>連続整数を<code>iota</code>で定義できる<div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln>1</span><span class=kd>const</span> <span class=p>(</span>
<span class=ln>2</span>      <span class=nx>a</span> <span class=p>=</span> <span class=kc>iota</span>
<span class=ln>3</span>      <span class=nx>b</span>
<span class=ln>4</span>      <span class=nx>c</span>
<span class=ln>5</span>  <span class=p>)</span>
<span class=ln>6</span>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%d, %d, %d&#34;</span><span class=p>,</span> <span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>c</span><span class=p>)</span> <span class=c1>// -&gt; 1, 2, 3
</span></code></pre></div></li></ul><h2 id=3-関数と型>3. 関数と型</h2><ul><li>少し特殊な配列定義方法</li></ul><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln>1</span>	<span class=nx>array1</span> <span class=o>:=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>}</span>
<span class=ln>2</span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>array1</span><span class=p>)</span> <span class=c1>// [1 2 3]
</span><span class=ln>3</span><span class=c1></span>
<span class=ln>4</span>	<span class=nx>array2</span> <span class=o>:=</span> <span class=p>[</span><span class=o>...</span><span class=p>]</span><span class=kt>int</span><span class=p>{</span><span class=mi>5</span><span class=p>:</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>10</span><span class=p>:</span> <span class=mi>100</span><span class=p>}</span>
<span class=ln>5</span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>array2</span><span class=p>)</span> <span class=c1>// [0 0 0 0 0 50 0 0 0 0 10]
</span></code></pre></div><ul><li><p>arrayとslice</p><ul><li>arrayは固定長，静的</li><li>sliceは参照型，可変長，動的<ul><li>sliceの容量はメモリ確保済みのサイズなので拡張可能</li><li>容量オーバーしたら基本的に２倍の値を確保</li></ul></li></ul></li><li><p>slice trick</p></li></ul><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln>1</span>	<span class=c1>// slice tricks: cut
</span><span class=ln>2</span><span class=c1></span>	<span class=nx>aa</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>int</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>}</span>
<span class=ln>3</span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>aa</span><span class=p>)</span> <span class=c1>// [1, 2, 3, 4, 5]
</span><span class=ln>4</span><span class=c1></span>	<span class=nx>aa</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>aa</span><span class=p>[:</span><span class=mi>2</span><span class=p>],</span> <span class=nx>aa</span><span class=p>[</span><span class=mi>3</span><span class=p>:]</span><span class=o>...</span><span class=p>)</span>
<span class=ln>5</span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>aa</span><span class=p>)</span> <span class=c1>// [1, 2, 4, 5]
</span></code></pre></div><h2 id=4-パッケージ>4. パッケージ</h2><ul><li>go get => dep => modules (vgo)</li><li>modulesを使う<ul><li><code>go mod init</code> でgo.modを生成</li><li>main作成<div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln> 1</span><span class=kn>package</span> <span class=nx>main</span>
<span class=ln> 2</span>    
<span class=ln> 3</span><span class=kn>import</span> <span class=p>(</span>
<span class=ln> 4</span>    <span class=s>&#34;fmt&#34;</span>
<span class=ln> 5</span>    
<span class=ln> 6</span>    <span class=s>&#34;github.com/tenntenn/greeting&#34;</span>
<span class=ln> 7</span><span class=p>)</span>
<span class=ln> 8</span>    
<span class=ln> 9</span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
<span class=ln>10</span>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>greeting</span><span class=p>.</span><span class=nf>Do</span><span class=p>())</span>
<span class=ln>11</span><span class=p>}</span>
</code></pre></div></li><li><code>go run xxx.go</code> するとgo.modにパッケージ追記されて実行できる<ul><li>runする前に<code>go mod tidy</code>してもOK</li><li>vendorディレクトリ配下にパッケージダウンロードするときは<code>go mod vendor</code></li></ul></li><li>後方互換のないバージョン使う場合はimport時の記述を変える<div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln> 1</span><span class=kn>package</span> <span class=nx>main</span>
<span class=ln> 2</span>    
<span class=ln> 3</span><span class=kn>import</span> <span class=p>(</span>
<span class=ln> 4</span>    <span class=s>&#34;fmt&#34;</span>
<span class=ln> 5</span>  <span class=s>&#34;time&#34;</span>
<span class=ln> 6</span>    
<span class=ln> 7</span>    <span class=s>&#34;github.com/tenntenn/greeting/v2&#34;</span>
<span class=ln> 8</span><span class=p>)</span>
<span class=ln> 9</span>    
<span class=ln>10</span><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
<span class=ln>11</span>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>greeting</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()))</span>
<span class=ln>12</span><span class=p>}</span>
</code></pre></div></li></ul></li></ul><h2 id=5-コマンドラインツール>5. コマンドラインツール</h2><ul><li>forでファイル処理したいとき→forの中でdeferせず処理を関数化して関数の方でdeferする</li><li>NG<div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln>1</span><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>fn</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>fileNames</span> <span class=p>{</span>
<span class=ln>2</span>  <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
<span class=ln>3</span>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
<span class=ln>4</span>    <span class=c1>// エラー処理
</span><span class=ln>5</span><span class=c1></span>  <span class=p>}</span>
<span class=ln>6</span>  <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span> <span class=c1>// fを使った処理
</span><span class=ln>7</span><span class=c1></span><span class=p>}</span>
</code></pre></div></li><li>OK<div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln>1</span><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>fn</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>fileNames</span> <span class=p>{</span>
<span class=ln>2</span>  <span class=nx>err</span> <span class=o>:=</span> <span class=nf>readFile</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
<span class=ln>3</span>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=cm>/* エラー処理 */</span> <span class=p>}</span>
<span class=ln>4</span><span class=p>}</span>
</code></pre></div><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln>1</span><span class=kd>func</span> <span class=nf>readFile</span><span class=p>(</span><span class=nx>fn</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
<span class=ln>2</span>  <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
<span class=ln>3</span>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>err</span> <span class=p>}</span>
<span class=ln>4</span>    <span class=c1>// fを使った処理
</span><span class=ln>5</span><span class=c1></span>  <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
<span class=ln>6</span><span class=p>}</span>
</code></pre></div></li></ul><h2 id=6-抽象化>6. 抽象化</h2><ul><li>型スイッチ</li></ul><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln> 1</span>	<span class=c1>// type switch
</span><span class=ln> 2</span><span class=c1></span>	<span class=kd>var</span> <span class=nx>i</span> <span class=kd>interface</span><span class=p>{}</span>
<span class=ln> 3</span>	<span class=nx>i</span> <span class=p>=</span> <span class=mi>100</span>
<span class=ln> 4</span>	<span class=k>switch</span> <span class=nx>v</span> <span class=o>:=</span> <span class=nx>i</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
<span class=ln> 5</span>	<span class=k>case</span> <span class=kt>int</span><span class=p>:</span>
<span class=ln> 6</span>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>v</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span>
<span class=ln> 7</span>	<span class=k>case</span> <span class=kt>string</span><span class=p>:</span>
<span class=ln> 8</span>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>v</span> <span class=o>+</span> <span class=s>&#34;hoge&#34;</span><span class=p>)</span>
<span class=ln> 9</span>	<span class=k>default</span><span class=p>:</span>
<span class=ln>10</span>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>)</span>
<span class=ln>11</span>	<span class=p>}</span> 
</code></pre></div><h2 id=8-テストとテスタビリティ>8. テストとテスタビリティ</h2><ul><li><p><code>Example</code>で始まる関数名のテストを書くとGoDocにサンプルとして出力される</p></li><li><p>テーブル駆動テスト + サブテスト</p></li></ul><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln> 1</span><span class=kd>func</span> <span class=nf>TestIsOdd</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
<span class=ln> 2</span>  <span class=nx>cases</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>struct</span> <span class=p>{</span><span class=nx>name</span> <span class=kt>string</span><span class=p>;</span> <span class=nx>input</span> <span class=kt>int</span><span class=p>;</span> <span class=nx>expected</span> <span class=kt>bool</span><span class=p>}{</span>
<span class=ln> 3</span>    <span class=p>{</span><span class=nx>name</span><span class=p>:</span> <span class=s>&#34;+odd&#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=nx>expected</span><span class=p>:</span> <span class=kc>true</span><span class=p>},</span>
<span class=ln> 4</span>    <span class=p>{</span><span class=nx>name</span><span class=p>:</span> <span class=s>&#34;+even&#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=nx>expected</span><span class=p>:</span> <span class=kc>false</span><span class=p>},</span>
<span class=ln> 5</span>    <span class=p>{</span><span class=nx>name</span><span class=p>:</span> <span class=s>&#34;-odd&#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>:</span> <span class=o>-</span><span class=mi>5</span><span class=p>,</span> <span class=nx>expected</span><span class=p>:</span> <span class=kc>true</span><span class=p>},</span>
<span class=ln> 6</span>    <span class=p>{</span><span class=nx>name</span><span class=p>:</span> <span class=s>&#34;-even&#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>:</span> <span class=o>-</span><span class=mi>6</span><span class=p>,</span> <span class=nx>expected</span><span class=p>:</span> <span class=kc>false</span><span class=p>},</span>
<span class=ln> 7</span>    <span class=p>{</span><span class=nx>name</span><span class=p>:</span> <span class=s>&#34;zero&#34;</span><span class=p>,</span> <span class=nx>input</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>expected</span><span class=p>:</span> <span class=kc>false</span><span class=p>},</span>
<span class=ln> 8</span>  <span class=p>}</span>
<span class=ln> 9</span>  
<span class=ln>10</span>  <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>cases</span> <span class=p>{</span>
<span class=ln>11</span>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>c</span>
<span class=ln>12</span>    <span class=nx>t</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>testing</span><span class=p>.</span><span class=nx>T</span><span class=p>)</span> <span class=p>{</span>
<span class=ln>13</span>      <span class=k>if</span> <span class=nx>actual</span> <span class=o>:=</span> <span class=nf>IsOdd</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>input</span><span class=p>);</span> <span class=nx>c</span><span class=p>.</span><span class=nx>expected</span> <span class=o>!=</span> <span class=nx>actual</span> <span class=p>{</span>
<span class=ln>14</span>        <span class=nx>t</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
<span class=ln>15</span>          <span class=s>&#34;want IsOdd(%d) = %v, got %v&#34;</span><span class=p>,</span>
<span class=ln>16</span>          <span class=nx>c</span><span class=p>.</span><span class=nx>input</span><span class=p>,</span> <span class=nx>c</span><span class=p>.</span><span class=nx>expected</span><span class=p>,</span> <span class=nx>actual</span><span class=p>)</span>
<span class=ln>17</span>      <span class=p>}</span>
<span class=ln>18</span>    <span class=p>})</span>
<span class=ln>19</span>  <span class=p>}</span>
<span class=ln>20</span><span class=p>}</span>
</code></pre></div><ul><li>テストデータは<code>testdata</code>というディレクトリに入れる<ul><li>パッケージとして認識されなくなる</li></ul></li></ul><h2 id=9-ゴールーチンとチャネル>9. ゴールーチンとチャネル</h2><ul><li>goroutineが切り替わるタイミング<ul><li>(ブロックされる)チャネルへの読み書き</li><li>待ちが発生するシステムコール</li><li><code>time.Sleep</code></li><li>メモリ割り当て</li><li><code>runtime.Gosched</code></li></ul></li><li>チャネルをcloseすると受信場所にゼロ値が送られる＝ブロードキャスト，処理終了通知として使われる</li></ul><p class="mt-5 text-center"><span class=text-secondary>Tagged:</span>
<a href=https://jagijagijag1.github.io/tiny-notes/tags/go/ class="link-tag text-dark">#Go</a></p></article><div class="row pt-5 pb-5"><div class="col-6 text-left"><a class=text-reset href=https://jagijagijag1.github.io/tiny-notes/posts/2020_05_16_16_53_38/>&larr; Go + WebAssembly お試し</a></div><div class="col-6 text-right"><a class=text-reset href=https://jagijagijag1.github.io/tiny-notes/posts/2020_05_20_12_05_28/>Pythonデコレータ &rarr;</a></div></div></div></div></div></div></main><footer class="site-footer mt-5"><div class=container><div class="row justify-content-md-between"><div class="col-sm-12 col-md-4 mb-4"><h2 class="h5 mb-3">jagijagijag1 tiny tech notes</h2><p>Tiny fragments for my tech activities. More cohesive articles are on https://jagijagijag1.github.io/blog/</p></div><section id=pixela_access_counter class="col-sm-12 col-md-4 mb-4"><header><h5>Blog PVs</h5></header><div id=svg-load-area style="border:1px solid rgba(161,161,161,.3)"></div><div style=text-align:right>Powered by <a href=https://pixe.la/ target=_blank>Pixela</a></div></section><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js></script><script src=https://unpkg.com/tippy.js@3/dist/tippy.all.min.js></script><script>document.addEventListener('DOMContentLoaded',function(){$('#svg-load-area').load('https:\/\/pixe.la\/v1\/users\/jagijagijag1\/graphs\/qrunch-pv?mode=short',function(){tippy('.each-day',{arrow:true});});});</script><div class="col-4 col-md-2 mb-4"><h2 class="h5 mb-3">Menu</h2><ul class="nav flex-column"><li class=mb-1><a href=https://jagijagijag1.github.io/tiny-notes/ class=text-secondary>Home</a></li><li class=mb-1><a href=https://jagijagijag1.github.io/blog/ class=text-secondary>Blog (external)</a></li></ul></div></div><hr><div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-center"><div class="text-muted mb-3"><a href=https://10mohi6.tk class=text-reset>design</a> <a href=https://github.com/10mohi6/hugo-theme-simple-blog class=text-reset>theme</a></p></div></div></div></footer><script src=https://jagijagijag1.github.io/tiny-notes/js/add-on.js></script></body></html>