---
title: Go言語のLambda関数でAPI Gateway経由のJSON入力を処理するときのベース
date: 2019-02-16T22:12:26+0900
tags:
- lambda
- serverless framework
- Go
- API Gateway
categories:
- 開発メモ
author: jagijagijag1

status: public
created_at: 2019-02-16 22:12:26 +0900
updated_at: 2019-02-16 22:12:26 +0900
published_at: 2019-02-16 22:12:26 +0900
---
Go言語で作ったLambda関数にて，API Gateway経由でJSON形式の入力を受け取る処理のベース部分の作りについてメモ

### 環境
- MacOS Mojave
- Go 1.11.5
- Serverless Framework 1.37.1

### プロジェクト作成
- $GOHOME/src配下の任意フォルダで作業
  - `hello`と`world`の2つの関数(+API)を持つテンプレートが展開される

```bash
$ sls create -t aws-go-dep -p <project-name>
```

- `serverless.yml`に`region`を追記 + `hello`のメソッドをPOSTに変更

```yaml:serverless.yml
provider:
  name: aws
  runtime: go1.x
  region: ap-northeast-1
...
functions:
  hello:
    handler: bin/hello
    events:
      - http:
          path: wake-up
          method: post
...
```

### 関数修正
- `hello`側だけ修正してみる
  - リクエストのbodyにあるJSONを受け，得られた値を含む文字列を返すよう修正

```go:hello/main.go
package main

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

// Response is of type APIGatewayProxyResponse since we're leveraging the
// AWS Lambda Proxy Request functionality (default behavior)
//
// https://serverless.com/framework/docs/providers/aws/events/apigateway/#lambda-proxy-integration
type Response events.APIGatewayProxyResponse

// InputBody is struct for body contents in api request
type InputBody struct {
	Test string `json:"test"`
}

// Handler is our lambda handler invoked by the `lambda.Start` function call
func Handler(ctx context.Context, request events.APIGatewayProxyRequest) (Response, error) {
	var buf bytes.Buffer

	// parse request.Body and create InputBody
	var ib InputBody
	var err = json.Unmarshal([]byte(request.Body), &ib)
	if err != nil {
		var em = "Error in parsing input body json"
		fmt.Println(em)
		resp := Response{
			StatusCode: 400,
			Body:       em,
		}
		return resp, err
	}

	// if parsed, create return message
	var msg = "input is  " + ib.Test
	body, err := json.Marshal(map[string]interface{}{
		"message": msg,
	})
	if err != nil {
		return Response{StatusCode: 404}, err
	}
	json.HTMLEscape(&buf, body)

	resp := Response{
		StatusCode:      200,
		IsBase64Encoded: false,
		Body:            buf.String(),
		Headers: map[string]string{
			"Content-Type":           "application/json",
			"X-MyCompany-Func-Reply": "hello-handler",
		},
	}

	return resp, nil
}

func main() {
	lambda.Start(Handler)
}


```


#### 補足
- Go言語でJSONを受けるには以下の手順が必要
1. 想定入力のデータ構造をstructで定義
2. 結果をstruct変数を用意
3. request.Body配下の(JSON形式の)文字列をパース (Unmarshal)


### デプロイ
- 以下でデプロイ
  - `make deploy` = `make` + `sls deploy`

```bash
$ cd <project-name>
$ make deploy
```

- 出力メッセージ中にあるURLに`curl`やPostmanでアクセス
