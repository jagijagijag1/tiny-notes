---
title: Pythonデコレータ
date: 2020-05-20T12:05:28+0900
tags:
- Python
categories:
- 開発メモ
author: jagijagijag1

status: public
created_at: 2020-05-20 12:05:28 +0900
updated_at: 2020-05-20 12:05:28 +0900
published_at: 2020-05-20 12:05:28 +0900
---
- [Pythonのデコレータを理解するための12Step - Qiita](https://qiita.com/_rdtr/items/d3bc1a8d4b7eb375c368) の抜粋


- クロージャで関数定義時の自分を囲むスコープの情報を記憶している
  - そのため下記では定義した時点で与えた引数の情報を，関数実行時に与えなくても保持できる
```python
>>> def outer(x):
...     def inner():
...         print x
...     return inner
>>> print1 = outer(1)
>>> print2 = outer(2)
>>> print1()
1
>>> print2()
2
```

- デコレータ=関数を引数にとり，引き換えに新たな関数を返すcallable(*)
  - 与えられた関数に，処理を追加した関数を返す
```python
>>> def outer(some_func):
...     def inner():
...         print "before some_func"
...         ret = some_func() #1
...         return ret + 1
...     return inner
>>> def foo():
...     return 1
>>> decorated = outer(foo) #2
>>> decorated()
before some_func
2
```

- 座標オブジェクトに対して計算処理を後付したい場合
```python
>>> class Coordinate(object):
...     def __init__(self, x, y):
...         self.x = x
...         self.y = y
...     def __repr__(self):
...         return "Coord: " + str(self.__dict__)
>>> def add(a, b):
...     return Coordinate(a.x + b.x, a.y + b.y)
>>> def sub(a, b):
...     return Coordinate(a.x - b.x, a.y - b.y)
>>> one = Coordinate(100, 200)
>>> two = Coordinate(300, 200)
>>> add(one, two)
Coord: {'y': 400, 'x': 400}

>>> def wrapper(func):
...     def checker(a, b):
...         if a.x < 0 or a.y < 0:
...             a = Coordinate(a.x if a.x > 0 else 0, a.y if a.y > 0 else 0)
...         if b.x < 0 or b.y < 0:
...             b = Coordinate(b.x if b.x > 0 else 0, b.y if b.y > 0 else 0)
...         ret = func(a, b)
...         if ret.x < 0 or ret.y < 0:
...             ret = Coordinate(ret.x if ret.x > 0 else 0, ret.y if ret.y > 0 else 0)
...         return ret
...     return checker
>>> add = wrapper(add)
>>> sub = wrapper(sub)
>>> sub(one, two)
Coord: {'y': 0, 'x': 0}
>>> add(one, three)
Coord: {'y': 200, 'x': 100}
```

- `@`による糖衣構文
```python
def add(a, b):
    return Coordinate(a.x + b.x, a.y + b.y)
add = wrapper(add)
```
＝
```python
@wrapper
def add(a, b):
    return Coordinate(a.x + b.x, a.y + b.y)
```

- loggerの例
```python
>>> def logger(func):
...     def inner(*args, **kwargs): #1
...         print "Arguments were: %s, %s" % (args, kwargs)
...         return func(*args, **kwargs) #2
...     return inner
>>> @logger
... def foo1(x, y=1):
...     return x * y
>>> @logger
... def foo2():
...     return 2
>>> foo1(5, 4)
Arguments were: (5, 4), {}
20
>>> foo1(1)
Arguments were: (1,), {}
1
>>> foo2()
Arguments were: (), {}
2
```
