---
title: "API Fuzzing toolのRESTlerを動かす"
date: 2021-02-07T16:44:51+09:00
tags:
- RESTler
- REST API
- API testing
- Fuzzing
categories:
- 開発メモ
author: jagijagijag1
---

## RESTlerとは
> RESTler is the first stateful REST API fuzzing tool for automatically testing cloud services through their REST APIs and finding security and reliability bugs in these services. For a given cloud service with an OpenAPI/Swagger specification, RESTler analyzes its entire specification, and then generates and executes tests that exercise the service through its REST API.
- Microsoft製のFuzzing toolで，状態を持つ処理シーケンスを扱えるのが特徴 (状態を扱える＝API呼び出し→その結果を受けて次のAPI呼び出し，のような流れをテストできる)
  - 一番大元の論文のメモは→[RESTler: Stateful REST API Fuzzing - jagijagijag1 tiny tech notes](https://jagijagijag1.github.io/tiny-notes/posts/2021_01_11_22_09_22/)
  - OSSで公開されている→[GitHub - microsoft/restler-fuzzer: RESTler is the first stateful REST API fuzzing tool for automatically testing cloud services through their REST APIs and finding security and reliability bugs in these services.](https://github.com/microsoft/restler-fuzzer)
- FazzingについてはIPAのサイトに概要あり
  - [脆弱性対策：ファジング：IPA 独立行政法人 情報処理推進機構](https://www.ipa.go.jp/security/vuln/fuzzing.html)
- Windows/Linux 64-bitのみ対応なので，macOS上でDockerを使って動かしてみた例をメモ

## 環境
- macOS Catelina
- Docker Engine - Community
  - Version:          20.10.2

## 実行環境コンテナ準備
### .NET SDK入りDockerイメージ取得
- .NET core SDK 3.1が必要なので，下記のMicrosoft公式イメージを利用
  - [.NET SDK | Docker Hub](https://hub.docker.com/_/microsoft-dotnet-sdk/)
  - 下記コマンドだとOSはDebian 10
  - 他のOSにしたい場合はDokcer Hubに記載のタグを指定
```bash
$ docker pull mcr.microsoft.com/dotnet/sdk:3.1 
$ docker images
REPOSITORY                     TAG     IMAGE ID       CREATED         SIZE
mcr.microsoft.com/dotnet/sdk   3.1     52a3845cafb1   4 days ago      710MB
...
```

### コンテナ起動
- コンテナを立ち上げてbashに入る (お試しなのでDockerfile化せず直接作業)
```bash
$ docker run -it -d --name restler-test mcr.microsoft.com/dotnet/sdk:3.1
$ docker exec -it restler-test /bin/bash
```

### Python 3.8.2インストール
- Python 3.8.2が必要なのでインストール
  (お試しなのでrootユーザのままで作業，以下コマンド例はroot実行だが先頭シンボルは$で記載)
- 3.7しかリポジトリにないようなので下記を参考にインストール
  - [python - How to Install python3.8 on debian 10? - Stack Overflow](https://stackoverflow.com/questions/62830862/how-to-install-python3-8-on-debian-10)
```bash
$ apt update
$ apt install build-essential zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libsqlite3-dev libreadline-dev libffi-dev curl libbz2-dev
$ cd ~
$ curl -O https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tar.xz
$ tar -xf Python-3.8.2.tar.xz
$ cd Python-3.8.2
$ ./configure --enable-optimizations
$ nproc
3
$ make -j 3
$ make install
$ python3 --version
Pyhon 3.8.2
```

### `python`コマンドの設定
- RESTlerの処理の中では，`python`コマンドで自身の持つスクリプトを実行する
- ここまで設定した状態では，`python`コマンドがPython 2.7.x，`python3`コマンドががPython 3.8.xをさしているはず
- そのため，下記などにて`python`コマンドでPython 3.8.xが実行されるような設定が必要
  - `alias python="python3"`だとRESTler実行時に反映されないようでだめだった
```bash
$ which python
/usr/bin/python

$ ls -la /usr/bin/python
lrwxrwxrwx 1 root root       7 Mar  4  2019 /usr/bin/python -> python2

$ which python3
/usr/local/bin/python3

$ ln -fs /usr/local/bin/python3 /usr/bin/python

$ ls -la /usr/bin/python
lrwxrwxrwx 1 root root 22 Jan 27 05:35 /usr/bin/python -> /usr/local/bin/python3

$ python --version
Python 3.8.2
```

## RESTlerインストール
- READMEに従い下記を実行
```bash
$ git clone https://github.com/microsoft/restler-fuzzer.git
$ cd restler-fuzzer/
$ python3 ./build-restler.py --dest_dir ~/restler_bin #RESTlerファイル一式をおく任意のpath
```

## チュートリアル
- 下記に従って動かしてみる
  - [restler-fuzzer/TutorialDemoServer.md at main · microsoft/restler-fuzzer · GitHub](https://github.com/microsoft/restler-fuzzer/blob/main/docs/user-guide/TutorialDemoServer.md)
- デモ対象はブログの記事管理API
  - `<cloneしたrestler-fuzzerのpath>/demo_server/swagger.json`で定義されている
  - 例えば`GET /blog/posts`で記事一覧取得
  
### 0. デモサーバ準備
- まずFuzzing対象とするサーバを起動する必要あり
  - `demo_server/README.md`を参照
- Python環境を構築してサーバ起動
```bash
$ cd <cloneしたrestler-fuzzerのpath>/demo_server
$ python -m venv venv
$ source venv/bin/activate
$ pip install -r requirements.txt
$ python demo_server/app.py
```

### 1. Compile
- Swagger定義をRESTlerで解釈できる形式に変換する
```bash
$ mkdir ~/restler-test
$ cd $_
$ cp <cloneしたrestler-fuzzerのpath>/demo_server/swagger.json .
$ ~/restler_bin/restler/Restler compile --api_spec swagger.json
```

- `restler-fuzzer/demo_server/Compile`の下に結果が出力される
  - 例えば`grammar.json`に，RESTlerでSwagger定義を解釈した結果を保持
  - 例えば`dict.json`はfuzzingで使うパラメタ定義
```json:dict.json
{
  "restler_fuzzable_string": [
    "fuzzstring"
  ],
  ...
  "restler_fuzzable_uuid4": [
    "903bcc44-30cf-4ea7-968a-d9d0da7c072f"
  ],
  "restler_fuzzable_uuid4_unquoted": [],
  "restler_fuzzable_int": [
    "0",
    "1"
  ],
  "restler_fuzzable_number": [
    "0.1",
    "1.2"
  ],
  "restler_fuzzable_bool": [
    "true"
  ],
  ...
}
```

### 2. Test
- 各エンドポイント・メソッドに対しアクセス可能か，レスポンス受け取れるかテスト
```bash
$ ~/restler_bin/restler/Restler test --grammar_file Compile/grammar.py --dictionary_file Compile/dict.json --settings Compile/engine_settings.json --no_ssl
Log share was not specified.  Logs will not be uploaded.
Starting task Test...
Request coverage (successful / total): 5 / 6
No bugs were found.
Task Test succeeded.
Collecting logs...
```
- 成功すると，5/6のリクエストが成功したことが出力される
  - デモサーバを正常に起動できていないと全リクエストが失敗になる
- Tutorialページでは`GET /blog/posts?per_page=`で失敗するとあるが，自分の環境では`PUT /blog/posts/{post_id}`で失敗していた
  - ペイロードの`id`に文字列を入れてしまって404ぽい
  - 直し方は詳細調べないと不明

### 3. Fuzz-lean
- 各エンドポイント・メソッドに一度だけチェックをかける 
  - 説明には`a default set of checkers`とあるがなんのことか不明
```bash
$ ~/restler_bin/restler/Restler fuzz-lean --grammar_file Compile/grammar.py --dictionary_file Compile/dict.json --settings Compile/engine_settings.json --no_ssl
Log share was not specified.  Logs will not be uploaded.
Starting task FuzzLean...

ERROR: Results analyzer for logs in /root/restler-test/FuzzLean failed.

Request coverage (successful / total): 5 / 6
Bugs were found!
Bug buckets:

InvalidDynamicObjectChecker_20x: 1
InvalidDynamicObjectChecker_500: 1
PayloadBodyChecker_500: 1
Task FuzzLean succeeded.
Collecting logs...
```

- 検出されたバグの情報は`FizzLean/RestlerResults/experiment<...>/bug_buckets`に出力
  - `bug_buckets.txt`にサマリ
  - `InvalidDynamicObjectChecker_20x_1.txt`などに個別バグのもう少し詳細
    - このログのテキストファイルを入力にしてRESTlerを実行すれば，同じバグの再現が可能 (`--replay_log`オプション)
  - ここでは3つのバグ発見


- 以下，発見されたバグの解説
##### `InvalidDynamicObjectChecker_20x`
- まずブログ記事をPOST→レスポンスとして記事ID取得
- その後，当該IDを用いてブログ記事をGET，ただしFuzzerで余分なクエリ文字列付与
  - 具体的には，`GET /api/blog/posts/<ID>`とするところを，`GET /api/blog/posts/<ID>?inject_query_stirng=123`としてリクエスト発行
- エラー発生を期待してFuzzerで余計な情報を付け足したにもかかわらず，200系のレスポンスが返ってきてしまったのでバグと判定

##### `InvalidDynamicObjectChecker_500`
- まず`InvalidDynamicObjectChecker_20x`のケースと同じくPOST→余計なクエリ文字列つけてGET
- その後余計なクエリ文字列のところを`?inject_query_stirng=123`から`??`に変えてGET
- すると，500 Internal Server Errorをレスポンスとして受け取ったので，バグと判定

##### `PayloadBodyChecker_500`
- まずブログ記事をPOST→レスポンスとして記事ID取得
- その後，当該IDのブログ記事を更新するためのPUTするが，Fuzzerによりbodyから`id`と`checksum`が削除された状態でリクエストを発行
- その結果，500 Internal Server Errorをレスポンスとして受け取ったので，バグと判定

### 4. Fuzz
- API呼び出しの組み合わせも含めてFuzzingする
  - `--time_budget`は実行する時間(hour単位)の指定
  - 下記コマンドだと1時間実行される

```bash
$ ~/restler_bin/restler/Restler fuzz --grammar_file Compile/grammar.py --dictionary_file Compile/dict.json --settings Compile/engine_settings.json --no_ssl --time_budget 1
```

- 今回の例は小規模で複雑度が低いため，`FuzzLean`と同じバグしか発見していない


## その他
- ドキュメント見るかぎり維持れる項目とか機能がまだまだありそう
  - [restler-fuzzer/docs/user-guide at main · microsoft/restler-fuzzer · GitHub](https://github.com/microsoft/restler-fuzzer/tree/main/docs/user-guide)
- 実際に使うにはこの辺読まないとダメそう