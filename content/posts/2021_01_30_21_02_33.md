---
title: "Python/TyperでCLIツール開発メモ"
date: 2021-01-30T21:02:34+09:00
tags:
- Python
- Typer
- CLI
categories:
- 開発メモ
author: jagijagijag1
---

- pythonでCLIツール作るときのライブラリとして，[Click](https://click.palletsprojects.com/en/7.x/)が有名
- これを更に簡単に使えるようにしたライブラリとして[Typer](https://typer.tiangolo.com/)がある
- これを使って開発したときにつまづいたところのメモ
  - 基本的な使い方は公式ドキュメントを読むのが一番よかった
  - 下記の記事は公式に記載の情報の多くを抜粋・和訳してくれている
    [オプション解析モジュール typer を使いこなそう - Qiita](https://qiita.com/iisaka51/items/18bde4dada0827fbe81e)

### やりたいこと
- 複数のサブコマンドをもつコマンドを作る
  - `foo`コマンドが，2つのサブコマンド`bar`と`baz`を持つ
  - `bar`コマンドは，1機能しか持たない(サブコマンドを持たない)が，単体実行したいかつモジュール(実装ファイル)を分けたいのでサブコマンドとしたい
  - `baz`コマンドは，さらに2つのサブコマンド`qux`と`corge`を持つ
```bash
# コマンドイメージ
$ foo bar <arg>
...(some output)...

$ foo baz qux <arg>
...(some output)...

$ foo baz corge <arg>
...(some output)...
```

- また，各サブコマンドは単体でも実行できるようにする
```bash
# コマンドイメージ
$ bar <arg>
...(some output)...

$ baz qux <arg>
...(some output)...

$ baz corge <arg>
...(some output)...
```

- 実装のファイル構成イメージは以下
```
my_cli
├── commands
│   ├── bar.py
│   └── baz.py
└── foo.py
```

### つまづきポイント
- Typerのコマンドは，登録されたコマンドが1つしかない場合，サブコマンドなしで実行できる

##### 実装
```python:commands/bar.py
import typer

barapp = typer.Typer(add_completion=False)


@barapp.command()
def main(arg: str):
    typer.echo(f"This is bar command: {arg}")


if __name__ == "__main__":
    barapp()
```

##### 実行結果
```bash
$ python commands/bar.py --help
Usage: bar.py [OPTIONS] ARG

Arguments:
  ARG  [required]

Options:
  --help  Show this message and exit.

$ python commands/bar.py hoge
This is bar command: hoge
```

- しかし，このコマンドを，他のコマンドのサブコマンドとして登録すると，サブコマンドなしで実行できなくなる
##### 実装
```python:foo.py
import typer
from commands import bar

fooapp = typer.Typer(add_completion=False)
fooapp.add_typer(bar.barapp, name="bar")
fooapp.add_typer(baz.bazapp, name="baz")


if __name__ == "__main__":
    fooapp()
```

##### 実行結果
```bash
$ python foo.py bar --help
Usage: foo.py bar [OPTIONS] COMMAND [ARGS]...

Options:
  --help  Show this message and exit.

Commands:
  main

# `foo bar hoge` は実行不可
$ python foo.py bar main hoge
This is bar command: hoge
```

### 解決
- `fooapp.add_typer(...)`でtyperごと登録するのはだめなので，`fooapp.command(name=<サブコマンド名>)(<外部定義関数>)`で外部ファイルの関数だけ登録する
##### 実装
```python:foo.py
import typer
from commands import bar

fooapp = typer.Typer(add_completion=False)
# fooapp.add_typer(bar.barapp, name="bar")
fooapp.command(name="bar")(bar.main)
fooapp.add_typer(baz.bazapp, name="baz")


if __name__ == "__main__":
    fooapp()
```

##### 実行結果
```bash
$ python foo.py bar --help
Usage: foo.py [OPTIONS] ARG

Arguments:
  ARG  [required]

Options:
  --help  Show this message and exit.

$ python foo.py bar hoge
This is bar command: hoge
```

### 実装例
- `python foo.py baz ...`も含めた実装例は以下
  - [GitHub - jagijagijag1/typer-subcommand-sample](https://github.com/jagijagijag1/typer-subcommand-sample)