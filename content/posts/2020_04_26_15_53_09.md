---
title: conftestざっくり調査
date: 2020-04-26T15:53:09+0900
tags:
- conftest
- Rego
categories:
- 開発メモ
author: jagijagijag1

status: public
created_at: 2020-04-26 15:53:09 +0900
updated_at: 2020-04-29 09:54:06 +0900
published_at: 2020-04-26 15:53:09 +0900
---
[GitHub - instrumenta/conftest: Write tests against structured configuration data using the Open Policy Agent Rego query language](https://github.com/instrumenta/conftest)

- YAML/JSONをチェックできるツール
- チェックする内容はOpen Policy Agentの規定する言語Regoで記述
  - [Open Policy Agent](https://www.openpolicyagent.org/)
  - [Open Policy Agent \| Policy Language](https://www.openpolicyagent.org/docs/latest/policy-language/)
    - datalog inspiredらしい
- k8sのマニフェストに使われる事例が多いが機能としては汎用的

- ルールの例

```deployment.rego:rego
package main

deny[msg] {
  input.kind = "Deployment"
  not input.spec.template.spec.securityContext.runAsNonRoot = true
  msg = "Containers must not run as root"
}

deny[msg] {
  input.kind = "Deployment"
  not input.spec.selector.matchLabels.app
  msg = "Containers must provide app label for pod selectors"
}
```

##### 2020/04/27追記
- 複数ファイルを与えてチェックもできる
  `conftest test --policy ./policy --input yaml ./manifests/* --combine`
- ref: [Conftest で CI 時に Rego で記述したテストを行う - @amsy810's Blog](https://amsy810.hateblo.jp/entry/2020/04/03/124913)

- データ構造に問い合わせて値をチェック
- 値の範囲とかの制約はかける?
